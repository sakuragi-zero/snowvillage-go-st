# 開発者向け手順書 - PostgreSQL + DevContainer環境

## 概要
このプロジェクトはDevContainer環境でPostgreSQLデータベースを使用した開発を行います。  
DevContainer起動時に自動的にPostgreSQLコンテナも起動され、開発に必要な環境が整います。

## 開発環境セットアップ

### 1. 前提条件
- Visual Studio Code
- Docker Desktop
- Dev Containers拡張機能

### 2. 開発環境の起動

#### 2.1 DevContainerを開く
1. VSCodeでプロジェクトを開く
2. `Ctrl+Shift+P` (Mac: `Cmd+Shift+P`) でコマンドパレットを開く
3. `Dev Containers: Reopen in Container` を選択
4. 初回は数分かかりますが、PostgreSQLコンテナと開発コンテナが自動起動します

#### 2.2 環境の確認
```bash
# PostgreSQL接続確認
echo "DB接続先: $DB_HOST:$DB_PORT"
echo "データベース: $DB_NAME"

# 詳細なデータベース疎通確認（推奨）
cd app
uv run python ../db_connection_test.py
```

**簡易接続テスト**
```bash
# データベース接続テスト（開発コンテナ内で実行）
python -c "
import psycopg2
import os
try:
    conn = psycopg2.connect(
        host=os.getenv('DB_HOST'),
        database=os.getenv('DB_NAME'),
        user=os.getenv('DB_USER'),
        password=os.getenv('DB_PASSWORD'),
        port=os.getenv('DB_PORT')
    )
    print('✅ PostgreSQL接続成功')
    conn.close()
except Exception as e:
    print(f'❌ PostgreSQL接続失敗: {e}')
"
```

## 開発作業の流れ

### 3. アプリケーション開発

#### 3.1 依存関係のインストール
```bash
cd app
pip install uv
uv sync
```

#### 3.2 アプリケーションの起動
```bash
cd app
uv run python -m streamlit run launch_screen.py
```

**注意**: `uv run streamlit run`コマンドは動作しない場合があります。必ず`uv run python -m streamlit run`形式を使用してください。

アプリケーションは `http://localhost:8501` でアクセス可能です。

#### 3.3 データベース初期化
初回起動時、データベーステーブルは自動作成されます。  
既存のSQLiteデータを移行する場合：

```bash
# プロジェクトルートで実行
python migrate_sqlite_to_postgres.py
```

### 4. データベース操作

#### 4.1 PostgreSQL接続情報（開発環境）
- **ホスト**: postgres-dev
- **ポート**: 5432  
- **データベース名**: snowvillage
- **ユーザー名**: postgres
- **パスワード**: devpassword

#### 4.2 psqlでの直接接続
```bash
# DevContainer内から
psql -h postgres-dev -U postgres -d snowvillage

# ローカルから（ポートフォワード経由）
psql -h localhost -U postgres -d snowvillage -p 5432
```

#### 4.3 よく使うSQL
```sql
-- ユーザーテーブル確認
SELECT * FROM users ORDER BY created_at DESC;

-- テーブル構造確認
\d users

-- データ件数確認  
SELECT COUNT(*) FROM users;
```

### 5. デバッグとテスト

#### 5.1 データベース疎通確認
```bash
# 包括的なデータベステスト
cd app
uv run python ../db_connection_test.py

# 出力例:
# === データベース疎通確認 ===
# テスト開始時刻: 2025-08-09 02:33:45.376455
# 接続先: postgres-dev:5432
# データベース: snowvillage
# ユーザー: postgres
# ----------------------------------------
# 1. データベース接続テスト...
#    ✓ 接続成功
#    PostgreSQLバージョン: PostgreSQL 15.13 
#    データベース現在時刻: 2025-08-09 02:33:45.381255+00:00
# 
# 2. テーブル一覧確認...
#    ✓ 検出されたテーブル数: 1
#    - users
# 
# 3. usersテーブル詳細確認...
#    ✓ 登録ユーザー数: 5
#    最新の登録ユーザー（最大5件）:
#    - testuser (登録: 2025-08-09 01:15:30, 最終ログイン: 2025-08-09 02:10:15)
# ----------------------------------------
# ✓ データベース疎通確認が完了しました
```

#### 5.2 ログ確認
```bash
# PostgreSQLログ確認
docker compose -f docker-compose.dev.yml logs postgres-dev

# アプリケーションは通常のPythonデバッグが可能
```

#### 5.3 データベースリセット
```bash
# PostgreSQL開発データベースを完全リセット
docker compose -f docker-compose.dev.yml down -v
docker compose -f docker-compose.dev.yml up -d postgres-dev
```

### 6. プロダクション環境との違い

| 項目 | 開発環境 | プロダクション環境 |
|------|----------|-------------------|
| compose file | docker-compose.dev.yml | docker-compose.yml |
| DB password | devpassword | password |
| DB container name | postgres-dev | snowvillage-postgres |
| 起動方法 | DevContainer自動 | 手動 `docker compose up` |

## トラブルシューティング

### 問題1: PostgreSQL接続エラー
```bash
# PostgreSQLコンテナ状態確認
docker compose -f docker-compose.dev.yml ps

# PostgreSQLコンテナ再起動
docker compose -f docker-compose.dev.yml restart postgres-dev
```

### 問題2: DevContainer起動失敗
1. Docker Desktopが起動しているか確認
2. `.devcontainer.json` の設定確認
3. 必要に応じてコンテナイメージを削除して再構築

### 問題3: ポートコンフリクト
既にポート5432が使用されている場合：
```yaml
# docker-compose.dev.yml の postgres-dev サービス
ports:
  - "5433:5432"  # 別のポートに変更
```

### 問題4: データが消える
開発データが重要な場合：
```bash
# データベースバックアップ
docker compose -f docker-compose.dev.yml exec postgres-dev pg_dump -U postgres snowvillage > backup.sql

# データベースリストア  
docker compose -f docker-compose.dev.yml exec -T postgres-dev psql -U postgres snowvillage < backup.sql
```

## 便利なVSCode設定

### settings.json に追加推奨
```json
{
  "python.defaultInterpreterPath": "/usr/local/bin/python",
  "python.terminal.activateEnvironment": true,
  "files.autoSave": "afterDelay",
  "files.autoSaveDelay": 1000
}
```

## コミット前のチェック

```bash
# コード品質チェック（開発環境で実行）
cd app
uv run black .
uv run flake8 .
uv run mypy .

# テスト実行（テストファイルがある場合）
uv run pytest
```

---

## 実装済み機能一覧

### 7. 進捗管理システム

#### 7.1 システム概要
- ユーザー別のタスク進捗管理
- クイズ形式とSNS投稿形式のミッション
- YAMLファイルによるタスク定義

#### 7.2 関連ファイル
- **`app/task_db.py`**: タスクデータベース操作
- **`app/tasks.py`**: YAMLファイル同期機能
- **`app/tasks.yml`**: タスク定義ファイル
- **`app/pages/dashboard.py`**: メインダッシュボード

#### 7.3 データベーススキーマ
```sql
-- タスクテーブル
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    task_type TEXT DEFAULT 'basic',  -- quiz, sns, basic
    description TEXT,
    content JSONB  -- クイズ問題やSNS要件
);

-- 進捗テーブル（ユーザー×タスクの完了状況）
CREATE TABLE progress (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    task_id INT NOT NULL,
    completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks(id),
    UNIQUE(user_id, task_id)
);
```

#### 7.4 タスク定義形式（tasks.yml）
```yaml
# クイズタスク例
- id: 1
  title: "データ取得技術"
  type: "quiz"
  description: "データベースからのデータ取得に関する技術クイズです"
  content:
    question: "SQLでテーブルの全てのレコードを取得するコマンドは？"
    options:
      - "SELECT * FROM table_name"
      - "GET ALL FROM table_name"
    correct_answer: 0

# SNSタスク例
- id: 2
  title: "AI・MLブースを訪問"
  type: "sns"
  description: "AI・MLブースを訪問してSNSに投稿しよう！"
  content:
    booth_name: "AI・MLテクノロジーブース"
    sns_prompt: "AI・MLブースで最新技術を体験中！ #SnowVillage"
    requirements:
      - "ブーススタッフと写真を撮る"
      - "ハッシュタグ #SnowVillage を含める"
```

#### 7.5 API使用方法
```python
from task_db import TaskService

# タスクサービス初期化
task_service = TaskService()

# ユーザーのタスク一覧取得
tasks = task_service.get_tasks_with_progress(user_id)

# タスク完了マーク
task_service.mark_task_complete(task_id, user_id)

# YAMLからタスク同期
from tasks import sync_yaml_to_db
sync_yaml_to_db("tasks.yml")
```

### 8. ランキングシステム

#### 8.1 システム概要
- ユーザーのタスク完了数に基づくランキング
- 同じ完了数の場合は初回完了日時で順位決定
- 上位10位までの表示

#### 8.2 関連ファイル
- **`app/pages/ranking.py`**: ランキング表示ページ
- **`app/task_db.py`**: ランキングクエリ機能

#### 8.3 ランキングロジック
```python
def get_user_ranking(self):
    """ユーザーのタスク完了数ランキングを取得（上位10位）"""
    query = """
        SELECT u.username, 
               COUNT(p.task_id) as completed_tasks,
               MIN(p.completed_at) as first_completion
        FROM users u
        LEFT JOIN progress p ON u.id = p.user_id
        GROUP BY u.id, u.username
        ORDER BY completed_tasks DESC, first_completion ASC NULLS LAST
        LIMIT 10
    """
```

#### 8.4 ページ遷移
- **ダッシュボード** ↔ **ランキング** ↔ **匿名投稿**
- サイドバーナビゲーションで統一

### 9. Slack Bot 匿名投稿システム

#### 9.1 システム概要
- 完全匿名でのSlackチャンネル投稿
- 送信時刻の自動付与
- エラーハンドリングと接続テスト機能

#### 9.2 関連ファイル
- **`app/slack_client.py`**: Slack API クライアント
- **`app/pages/post.py`**: 匿名投稿フォーム
- **`app/.streamlit/secrets.toml`**: Slack認証設定

#### 9.3 Slack設定手順
```bash
# 1. secrets.tomlファイル作成
mkdir -p app/.streamlit
cat > app/.streamlit/secrets.toml << 'EOF'
[slack]
bot_token = "xoxb-your-bot-token-here"
channel_id = "C0123456789"
bot_name = "Snow Village Bot"
EOF

# 2. Slack App作成手順
# - https://api.slack.com/apps でSlack Appを作成
# - OAuth & Permissions で chat:write スコープを追加
# - Install App to Workspace でトークンを取得
# - チャンネルにBotを招待: /invite @your_bot_name
```

#### 9.4 API使用方法
```python
from slack_client import SlackClient

# Slackクライアント初期化
slack_client = SlackClient()

# 設定確認
if slack_client.is_configured():
    # 匿名メッセージ送信
    success, message = slack_client.send_anonymous_message(
        message="テストメッセージ",
        username="user123"  # ログ用（Slackには表示されない）
    )
    
    # 接続テスト
    success, result = slack_client.test_connection()
```

#### 9.5 メッセージフォーマット
```
🏔️ **Snow Village 匿名投稿**

📝 **メッセージ:**
ユーザーが入力したメッセージ内容

🕐 **投稿時刻:** 2025年8月17日 12:34:56
👤 **投稿者:** 匿名ユーザー
```

### 10. 開発・デバッグ用コマンド

#### 10.1 データベース操作
```bash
# データベースクリーンアップ（usersテーブル以外削除）
cd app
uv run python ../db_cleanup.py

# データベース接続・テーブル確認
uv run python ../db_connection_test.py

# TaskService機能テスト
uv run python -c "
from task_db import TaskService
ts = TaskService()
print('TaskService initialized successfully')
ranking = ts.get_user_ranking()
print(f'Current ranking: {len(ranking)} users')
"
```

#### 10.2 Slack機能テスト
```bash
# Slack設定確認
cd app
uv run python -c "
from slack_client import SlackClient
client = SlackClient()
print(f'Slack configured: {client.is_configured()}')
if client.is_configured():
    success, msg = client.test_connection()
    print(f'Connection test: {success} - {msg}')
"
```

#### 10.3 アプリケーション起動
```bash
# 開発環境での起動
cd app
uv run streamlit run main.py

# 特定ポートでの起動
uv run streamlit run main.py --server.port 8502

# ヘッドレスモード（バックグラウンド）
uv run streamlit run main.py --server.headless true
```

### 11. ファイル構成

```
app/
├── main.py                    # アプリケーションエントリーポイント
├── launch_screen.py           # ログイン画面
├── user.py                    # ユーザー管理
├── task_db.py                 # タスクデータベース操作
├── tasks.py                   # YAML同期機能
├── tasks.yml                  # タスク定義
├── slack_client.py            # Slack API クライアント
├── pages/
│   ├── dashboard.py           # メインダッシュボード
│   ├── ranking.py             # ランキングページ
│   └── post.py                # 匿名投稿ページ
├── frontend/public/           # 静的リソース
├── .streamlit/
│   └── secrets.toml           # Slack認証設定
└── pyproject.toml             # Python依存関係
```

### 12. トラブルシューティング（機能別）

#### 12.1 タスク管理エラー
```bash
# タスクが表示されない場合
cd app
uv run python -c "
from tasks import sync_yaml_to_db
sync_yaml_to_db('tasks.yml')
print('Tasks synced from YAML')
"

# ユーザーIDエラーの場合
# dashboard.pyでget_tasks_with_progress(user_id)にuser_idが正しく渡されているか確認
```

#### 12.2 ランキング表示エラー
```bash
# ランキングデータ確認
cd app
uv run python -c "
from task_db import TaskService
ts = TaskService()
ranking = ts.get_user_ranking()
for i, rank in enumerate(ranking, 1):
    print(f'{i}. {rank[\"username\"]}: {rank[\"completed_tasks\"]} tasks')
"
```

#### 12.3 Slack投稿エラー
```bash
# 一般的なSlackエラーと対処法
# "channel_not_found" → チャンネルIDを確認
# "not_in_channel" → ボットをチャンネルに招待
# "invalid_auth" → トークンを再確認

# 詳細ログ確認
cd app
uv run python -c "
import logging
logging.basicConfig(level=logging.DEBUG)
from slack_client import SlackClient
client = SlackClient()
success, msg = client.send_anonymous_message('test message')
print(f'Result: {success} - {msg}')
"
```

---

この環境により、PostgreSQLを使用したフルスタック開発がDevContainer内で完結します。進捗管理、ランキング、Slack連携機能が統合されたイベント管理システムとして利用できます。