# 開発者向け手順書 - PostgreSQL + DevContainer環境

## 概要
このプロジェクトはDevContainer環境でPostgreSQLデータベースを使用した開発を行います。  
DevContainer起動時に自動的にPostgreSQLコンテナも起動され、開発に必要な環境が整います。

## 開発環境セットアップ

### 1. 前提条件
- Visual Studio Code
- Docker Desktop
- Dev Containers拡張機能

### 2. 開発環境の起動

#### 2.1 DevContainerを開く
1. VSCodeでプロジェクトを開く
2. `Ctrl+Shift+P` (Mac: `Cmd+Shift+P`) でコマンドパレットを開く
3. `Dev Containers: Reopen in Container` を選択
4. 初回は数分かかりますが、PostgreSQLコンテナと開発コンテナが自動起動します

#### 2.2 環境の確認
```bash
# PostgreSQL接続確認
echo "DB接続先: $DB_HOST:$DB_PORT"
echo "データベース: $DB_NAME"

# 詳細なデータベース疎通確認（推奨）
cd app
uv run python ../db_connection_test.py
```

**簡易接続テスト**
```bash
# データベース接続テスト（開発コンテナ内で実行）
python -c "
import psycopg2
import os
try:
    conn = psycopg2.connect(
        host=os.getenv('DB_HOST'),
        database=os.getenv('DB_NAME'),
        user=os.getenv('DB_USER'),
        password=os.getenv('DB_PASSWORD'),
        port=os.getenv('DB_PORT')
    )
    print('✅ PostgreSQL接続成功')
    conn.close()
except Exception as e:
    print(f'❌ PostgreSQL接続失敗: {e}')
"
```

## 開発作業の流れ

### 3. アプリケーション開発

#### 3.1 依存関係のインストール
```bash
cd app
pip install uv
uv sync
```

#### 3.2 アプリケーションの起動
```bash
cd app
uv run streamlit run launch_screen.py
```

または

```bash
cd app
streamlit run launch_screen.py
```

アプリケーションは `http://localhost:8501` でアクセス可能です。

#### 3.3 データベース初期化
初回起動時、データベーステーブルは自動作成されます。  
既存のSQLiteデータを移行する場合：

```bash
# プロジェクトルートで実行
python migrate_sqlite_to_postgres.py
```

### 4. データベース操作

#### 4.1 PostgreSQL接続情報（開発環境）
- **ホスト**: postgres-dev
- **ポート**: 5432  
- **データベース名**: snowvillage
- **ユーザー名**: postgres
- **パスワード**: devpassword

#### 4.2 psqlでの直接接続
```bash
# DevContainer内から
psql -h postgres-dev -U postgres -d snowvillage

# ローカルから（ポートフォワード経由）
psql -h localhost -U postgres -d snowvillage -p 5432
```

#### 4.3 よく使うSQL
```sql
-- ユーザーテーブル確認
SELECT * FROM users ORDER BY created_at DESC;

-- テーブル構造確認
\d users

-- データ件数確認  
SELECT COUNT(*) FROM users;
```

### 5. デバッグとテスト

#### 5.1 データベース疎通確認
```bash
# 包括的なデータベステスト
cd app
uv run python ../db_connection_test.py

# 出力例:
# === データベース疎通確認 ===
# テスト開始時刻: 2025-08-09 02:33:45.376455
# 接続先: postgres-dev:5432
# データベース: snowvillage
# ユーザー: postgres
# ----------------------------------------
# 1. データベース接続テスト...
#    ✓ 接続成功
#    PostgreSQLバージョン: PostgreSQL 15.13 
#    データベース現在時刻: 2025-08-09 02:33:45.381255+00:00
# 
# 2. テーブル一覧確認...
#    ✓ 検出されたテーブル数: 1
#    - users
# 
# 3. usersテーブル詳細確認...
#    ✓ 登録ユーザー数: 5
#    最新の登録ユーザー（最大5件）:
#    - testuser (登録: 2025-08-09 01:15:30, 最終ログイン: 2025-08-09 02:10:15)
# ----------------------------------------
# ✓ データベース疎通確認が完了しました
```

#### 5.2 ログ確認
```bash
# PostgreSQLログ確認
docker compose -f docker-compose.dev.yml logs postgres-dev

# アプリケーションは通常のPythonデバッグが可能
```

#### 5.3 データベースリセット
```bash
# PostgreSQL開発データベースを完全リセット
docker compose -f docker-compose.dev.yml down -v
docker compose -f docker-compose.dev.yml up -d postgres-dev
```

### 6. プロダクション環境との違い

| 項目 | 開発環境 | プロダクション環境 |
|------|----------|-------------------|
| compose file | docker-compose.dev.yml | docker-compose.yml |
| DB password | devpassword | password |
| DB container name | postgres-dev | snowvillage-postgres |
| 起動方法 | DevContainer自動 | 手動 `docker compose up` |

## トラブルシューティング

### 問題1: PostgreSQL接続エラー
```bash
# PostgreSQLコンテナ状態確認
docker compose -f docker-compose.dev.yml ps

# PostgreSQLコンテナ再起動
docker compose -f docker-compose.dev.yml restart postgres-dev
```

### 問題2: DevContainer起動失敗
1. Docker Desktopが起動しているか確認
2. `.devcontainer.json` の設定確認
3. 必要に応じてコンテナイメージを削除して再構築

### 問題3: ポートコンフリクト
既にポート5432が使用されている場合：
```yaml
# docker-compose.dev.yml の postgres-dev サービス
ports:
  - "5433:5432"  # 別のポートに変更
```

### 問題4: データが消える
開発データが重要な場合：
```bash
# データベースバックアップ
docker compose -f docker-compose.dev.yml exec postgres-dev pg_dump -U postgres snowvillage > backup.sql

# データベースリストア  
docker compose -f docker-compose.dev.yml exec -T postgres-dev psql -U postgres snowvillage < backup.sql
```

## 便利なVSCode設定

### settings.json に追加推奨
```json
{
  "python.defaultInterpreterPath": "/usr/local/bin/python",
  "python.terminal.activateEnvironment": true,
  "files.autoSave": "afterDelay",
  "files.autoSaveDelay": 1000
}
```

## コミット前のチェック

```bash
# コード品質チェック（開発環境で実行）
cd app
uv run black .
uv run flake8 .
uv run mypy .

# テスト実行（テストファイルがある場合）
uv run pytest
```

---

この環境により、PostgreSQLを使用したフルスタック開発がDevContainer内で完結します。